import * as vscode from 'vscode';
import * as fs from 'fs';
import * as path from 'path';

/**
 * Cursor AI Rules Manager
 * .cursorrules ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®QueryCanvasãƒ«ãƒ¼ãƒ«è¿½åŠ ã‚’ç®¡ç†
 */
export class CursorRulesManager {
    private static readonly SECTION_START = '# ========================================';
    private static readonly SECTION_TITLE = '# QueryCanvas - Database Client Rules';
    private static readonly SECTION_END = '# ========================================';

    /**
     * .cursorrules ã«QueryCanvasã®ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ 
     */
    public static async addQueryCanvasRules(): Promise<void> {
        const workspaceFolders = vscode.workspace.workspaceFolders;
        if (!workspaceFolders) {
            vscode.window.showErrorMessage('ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒé–‹ã‹ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
        }

        const rootPath = workspaceFolders[0].uri.fsPath;
        const cursorRulesPath = path.join(rootPath, '.cursorrules');

        try {
            // æ—¢å­˜ã® .cursorrules ã‚’èª­ã¿è¾¼ã‚€
            let content = '';
            let fileExists = false;

            if (fs.existsSync(cursorRulesPath)) {
                content = fs.readFileSync(cursorRulesPath, 'utf8');
                fileExists = true;

                // æ—¢ã«QueryCanvasã®ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚‹å ´åˆ
                if (this.hasQueryCanvasSection(content)) {
                    const choice = await vscode.window.showWarningMessage(
                        'QueryCanvasã®ãƒ«ãƒ¼ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ',
                        'ã¯ã„', 'ã„ã„ãˆ'
                    );
                    if (choice !== 'ã¯ã„') {
                        return;
                    }

                    // æ—¢å­˜ã®QueryCanvasã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
                    content = this.removeQueryCanvasSection(content);
                }
            }

            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ
            const template = this.getTemplate();

            // ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ 
            if (fileExists && content.trim().length > 0) {
                // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ«ã®æœ€å¾Œã«è¿½åŠ 
                content = content.trimEnd() + '\n\n' + template;
            } else {
                // æ–°è¦ä½œæˆ
                content = template;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
            fs.writeFileSync(cursorRulesPath, content, 'utf8');

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const choice = await vscode.window.showInformationMessage(
                'âœ… .cursorrules ã«QueryCanvasã®ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\n\nCursor AI ã«è©¦ã—ã¦ãã ã•ã„ï¼š\n"@Codebase PowerPointã«è²¼ã‚Šä»˜ã‘ã‚‰ã‚Œã‚‹ã‚¯ã‚¨ãƒªã‚’ä½œã£ã¦"',
                'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã', 'é–‰ã˜ã‚‹'
            );

            if (choice === 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã') {
                const doc = await vscode.workspace.openTextDocument(cursorRulesPath);
                await vscode.window.showTextDocument(doc);
            }
        } catch (error) {
            vscode.window.showErrorMessage(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`);
        }
    }

    /**
     * QueryCanvasã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
     */
    private static hasQueryCanvasSection(content: string): boolean {
        return content.includes(this.SECTION_TITLE);
    }

    /**
     * QueryCanvasã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
     */
    private static removeQueryCanvasSection(content: string): string {
        const lines = content.split('\n');
        const result: string[] = [];
        let inQueryCanvasSection = false;
        let sectionStartIndex = -1;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];

            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹ã‚’æ¤œå‡º
            if (line.includes(this.SECTION_TITLE)) {
                inQueryCanvasSection = true;
                sectionStartIndex = i;
                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å‰ã®ç©ºè¡Œã‚’å‰Šé™¤ï¼ˆæœ€å¤§2è¡Œï¼‰
                while (result.length > 0 && result[result.length - 1].trim() === '') {
                    result.pop();
                }
                continue;
            }

            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (inQueryCanvasSection) {
                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®çµ‚ã‚ã‚Šã‚’æ¤œå‡ºï¼ˆæ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«çµ‚ç«¯ï¼‰
                if (line.startsWith('# ===') && i > sectionStartIndex + 2) {
                    // æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹ãªã®ã§ã€ã“ã®è¡Œã¯æ®‹ã™
                    inQueryCanvasSection = false;
                    result.push(line);
                }
                continue;
            }

            result.push(line);
        }

        return result.join('\n');
    }

    /**
     * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ
     */
    private static getTemplate(): string {
        const version = this.getExtensionVersion();

        return `${this.SECTION_START}
${this.SECTION_TITLE}
# Auto-generated by QueryCanvas v${version}
${this.SECTION_END}

## âš ï¸ MOST IMPORTANT: SQL Display Options Syntax

When generating SQL with display options, follow these rules EXACTLY:

### @column directive (cell styling)
\`\`\`sql
@column <name> type=int if<0:color=red
\`\`\`
- Use \`if<operator><value>:style\` for conditions
- Example: \`@column å£²ä¸Š type=int if<0:color=red if>1000000:color=green\`

### @row directive (entire row styling)
\`\`\`sql
@row <column_name><operator><value>:<styles>
\`\`\`
- **NO \`if\` keyword!**
- Use \`==\` (double equals) for equality
- Quote strings: \`"value"\` or \`'value'\`
- Use \`bg\` NOT \`background\`
- Example: \`@row æ›œæ—¥=="åœŸ":bg=#eeeeff\`
- Example: \`@row å£²ä¸Š>1000000:bg=#ccffcc,bold=true\`

### @chart directive (graph visualization) ğŸ†•
\`\`\`sql
@chart type=line x=æ—¥ä»˜ y=å£²ä¸Š,åˆ©ç›Š
@chart type=mixed x=æœˆ y=å£²ä¸Š:bar,ç›®æ¨™:line
\`\`\`
- **Required:** \`type\`, \`x\` (or \`xAxis\`), \`y\` (or \`yAxis\`)
- **Chart types:** \`line\`, \`bar\`, \`pie\`, \`area\`, \`scatter\`, \`mixed\`
- **Y-axis:** Comma-separated for multiple series (e.g., \`y=åº—èˆ—A,åº—èˆ—B,åº—èˆ—C\`)
- **Mixed charts:** Specify type for each series: \`y=å£²ä¸Š:bar,ç›®æ¨™:line,é”æˆç‡:line\`
- **Optional:** \`title="ã‚¿ã‚¤ãƒˆãƒ«"\`, \`legend=true\`, \`grid=true\`, \`stacked=true\`, \`curve=smooth\`
- Example: \`@chart type=line x=æ—¥ä»˜ y=å°æ‘äº•åº—,äº¬æˆå°å²©åº— title="åº—èˆ—åˆ¥å£²ä¸Šæ¨ç§»"\`
- Example: \`@chart type=mixed x=æœˆ y=å£²ä¸Š:bar,ç›®æ¨™:line title="å£²ä¸Šã¨ç›®æ¨™"\`

### âŒ WRONG Examples
\`\`\`sql
@row if æ›œæ—¥=åœŸ:background=#eee     âŒ NO! Has 'if', uses '=', uses 'background'
@row å›½å=ãƒ•ãƒ©ãƒ³ã‚¹:bg=#fee           âŒ NO! No quotes, uses single '='
@chart x=æ—¥ä»˜                       âŒ NO! Missing required 'type' and 'y'
\`\`\`

### âœ… CORRECT Examples
\`\`\`sql
@row æ›œæ—¥=="åœŸ":bg=#eee              âœ… YES!
@row å›½å=="ãƒ•ãƒ©ãƒ³ã‚¹":bg=#fee        âœ… YES!
@row å£²ä¸Š>1000000:bg=#ccffcc         âœ… YES!
@chart type=line x=æ—¥ä»˜ y=å£²ä¸Š       âœ… YES!
@chart type=mixed x=æœˆ y=å£²ä¸Š:bar,ç›®æ¨™:line âœ… YES!
\`\`\`

---

## QueryCanvas Integration

This project uses QueryCanvas for database access and SQL query management.

### Session File

**Location:** \`.vscode/querycanvas-session.json\`

Contains:
- Current SQL query in the editor
- Active database connection ID
- You can edit this file directly to modify SQL

**Example prompts for Cursor AI:**
\`\`\`
Edit .vscode/querycanvas-session.json to add a WHERE clause filtering by date
\`\`\`

\`\`\`
Modify the SQL in the session file to add display options for PowerPoint
\`\`\`

### SQL Display Options

Format query results using \`/** @column ... */\` and \`/** @row ... */\` comments:

#### Column Styling (individual cells)
\`\`\`sql
/**
 * @column amount type=int align=right format=number comma=true if<0:color=red
 * @column date format=datetime pattern=yyyy/MM/dd
 */
SELECT amount, date FROM sales;
\`\`\`

#### Row Styling (entire rows)
\`\`\`sql
/**
 * @row æ›œæ—¥=="åœŸ":bg=#eeeeff
 * @row æ›œæ—¥=="æ—¥":bg=#ffeeee
 * @row å£²ä¸Š>1000000:bg=#ccffcc,bold=true
 * @column å£²ä¸Š type=int align=right format=number comma=true
 */
SELECT æ›œæ—¥, å£²ä¸Š FROM daily_sales;
\`\`\`

#### Graph Visualization ğŸ†•
\`\`\`sql
/**
 * @chart type=line x=æ—¥ä»˜ y=å°æ‘äº•åº—,äº¬æˆå°å²©åº— title="åº—èˆ—åˆ¥å£²ä¸Šæ¨ç§»"
 * @row æ›œæ—¥=="åœŸ":bg=#eeeeff
 * @row æ›œæ—¥=="æ—¥":bg=#ffeeee
 * @column å°æ‘äº•åº— type=int align=right format=number comma=true color="#FF0000"
 * @column äº¬æˆå°å²©åº— type=int align=right format=number comma=true color="#008800"
 */
SELECT æ—¥ä»˜, æ›œæ—¥, å°æ‘äº•åº—, äº¬æˆå°å²©åº— FROM daily_sales;
\`\`\`

**Chart types:**
- \`line\` - Line chart (trends, time-series)
- \`bar\` - Bar chart (category comparison)
- \`pie\` - Pie chart (proportions, market share)
- \`area\` - Area chart (cumulative data)
- \`scatter\` - Scatter plot (correlations)
- \`mixed\` - Mixed chart (bar + line): \`y=å£²ä¸Š:bar,ç›®æ¨™:line\`

**View toggle:**
- **ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«** button: Table view
- **ğŸ“ˆ ã‚°ãƒ©ãƒ•** button: Chart view
- **ğŸ“Š ã‚°ãƒ©ãƒ•ã‚³ãƒ”ãƒ¼** button: Copy chart as image for PowerPoint

**Mixed chart example:**
\`\`\`sql
/**
 * @chart type=mixed x=æœˆ y=å£²ä¸Š:bar,ç›®æ¨™:line title="å£²ä¸Šå®Ÿç¸¾ã¨ç›®æ¨™"
 * @column å£²ä¸Š type=int align=right format=number comma=true color="#36A2EB"
 * @column ç›®æ¨™ type=int align=right format=number comma=true color="#FF6384"
 */
SELECT æœˆ, å£²ä¸Š, ç›®æ¨™ FROM monthly_sales;
\`\`\`

**Common options:**
- \`align=right\` - Right align (recommended for numbers)
- \`format=number comma=true\` - Add thousand separators (1,234,567)
- \`decimal=2\` - 2 decimal places (e.g., 123.45)
- \`format=datetime pattern=yyyy/MM/dd\` - Date formatting
- \`if<0:color=red\` - Conditional styling (negatives in red) - FOR @column ONLY
- \`if>=100:color=green,bold=true\` - Multiple styles - FOR @column ONLY

**Row styling (entire row):**
- \`@row åˆ—å=="å€¤":bg=#è‰²\` - String comparison (quotes required!)
- \`@row åˆ—å>1000:bg=#è‰²,bold=true\` - Numeric comparison
- **IMPORTANT:** No \`if\` keyword, use \`==\` not \`=\`, quote strings

**Example prompts:**
\`\`\`
Add display options to format the 'price' column with commas and 2 decimal places
\`\`\`

\`\`\`
Create a sales report query with conditional styling: negative values red, values over 1M green
\`\`\`

\`\`\`
Add row styling to highlight weekends (Saturdays in light blue, Sundays in light red)
\`\`\`

### Syntax Comparison (IMPORTANT!)

| Feature | Column Style | Row Style |
|---------|-------------|-----------|
| Directive | \`@column\` | \`@row\` |
| Conditional | \`if<0:color=red\` | \`å£²ä¸Š<0:bg=#fcc\` |
| \`if\` keyword | âœ… YES (use \`if\`) | âŒ NO (\`if\` not used) |
| Equality | \`==\` or single \`=\` | \`==\` (double only) |
| String values | No quotes needed | MUST quote: \`"value"\` |
| Example | \`@column æç›Š type=int if<0:color=red\` | \`@row æ›œæ—¥=="åœŸ":bg=#eef\` |

### PowerPoint/Excel/Word Copy

After executing queries, copy buttons appear:

1. **ğŸ“‹ TSVã‚³ãƒ”ãƒ¼** (Tab-Separated Values)
   - Simple format, works everywhere
   - No styling preserved
   - Good for basic data transfer

2. **ğŸ“‹ HTMLã‚³ãƒ”ãƒ¼** (Rich HTML with styles)
   - Preserves colors, bold, formatting
   - Conditional styling maintained
   - Row styling maintained
   - Perfect for presentations

3. **ğŸ“Š ã‚°ãƒ©ãƒ•ã‚³ãƒ”ãƒ¼** (Chart as image) ğŸ†•
   - Available when \`@chart\` directive is used
   - Copy chart as PNG image
   - Paste directly into PowerPoint/Word/Keynote
   - Includes title, legend, colors, and all styling

**Example workflow for charts:**
\`\`\`
Create query with @chart â†’ Execute â†’ Click ğŸ“ˆ ã‚°ãƒ©ãƒ• â†’ Click ğŸ“Š ã‚°ãƒ©ãƒ•ã‚³ãƒ”ãƒ¼ â†’ Paste in PowerPoint
\`\`\`

**Example workflow:**
\`\`\`
Create a sales dashboard query with:
- Amount: right-aligned, comma-separated, negatives in red
- Achievement rate: 1 decimal, >=100% in green bold
- Date: yyyy/MM/dd format
- Rows with achievement >=100%: green background
Then copy as HTML for PowerPoint
\`\`\`

**Example prompts:**
\`\`\`
Generate a presentation-ready query for monthly sales. Use display options to make it look good in PowerPoint.
\`\`\`

\`\`\`
Create a report with row styling to highlight high-performing stores (sales > 1M) in green
\`\`\`

\`\`\`
Create a sales trend chart query showing store A and store B with line chart
\`\`\`

\`\`\`
Generate a mixed chart query with actual sales (bar) and target (line)
\`\`\`

### Database Schema

**Location:** \`querycanvas-schema/tables/\`

Auto-generated Markdown files for each table. You can add logical names and descriptions.

**Example prompts:**
\`\`\`
Based on the table definition in querycanvas-schema/tables/orders.md, write a query to analyze sales trends
\`\`\`

\`\`\`
Using the schema in querycanvas-schema/, create a join query between users and orders tables
\`\`\`

### Query Results

**Location:** \`querycanvas-results/\`

Saved query results in TSV/JSON format with metadata.

### Best Practices for QueryCanvas

1. **Always use display options for presentation-ready results**
   - Right-align numbers
   - Add commas for large numbers
   - Use conditional styling for highlights
   - Use row styling to highlight important data

2. **Leverage conditional styling (column-level)**
   - Red for negatives: \`@column æç›Š type=int if<0:color=red\`
   - Green for success: \`@column é”æˆç‡ type=float if>=100:color=green,bold=true\`
   - Orange for warnings: \`@column åœ¨åº«æ•° type=int if<=10:color=orange\`

3. **Leverage row styling (entire rows)**
   - Highlight weekends: \`@row æ›œæ—¥=="åœŸ":bg=#eeeeff\`
   - Highlight high performers: \`@row å£²ä¸Š>1000000:bg=#ccffcc,bold=true\`
   - Highlight status: \`@row ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹=="å®Œäº†":bg=#d4edda,color=#155724\`
   - **Remember:** No \`if\`, use \`==\`, quote strings!

4. **Prefer HTML Copy for PowerPoint**
   - Preserves all styling and formatting
   - Conditional colors maintained
   - Row styling maintained
   - Professional-looking tables

5. **Keep queries read-only**
   - QueryCanvas only allows SELECT, SHOW, DESC, EXPLAIN
   - INSERT, UPDATE, DELETE are blocked for safety

6. **Use Cursor AI to generate SQL**
   - Edit session file directly
   - Add display options automatically
   - Optimize for presentation

### Common Tasks

**Generate formatted query:**
\`\`\`
Write a top 10 customers query with display options optimized for PowerPoint
\`\`\`

**Add styling to existing query:**
\`\`\`
Add conditional styling to the session file: amounts <0 in red, >1M in green
\`\`\`

**Add row styling:**
\`\`\`
Add row styling to highlight weekends (Saturday and Sunday) with different background colors
\`\`\`

**Create presentation:**
\`\`\`
Generate a sales report query with:
- Store name: 150px width
- Revenue: right-aligned, comma-separated, conditional colors
- Growth rate: 1 decimal, percentage-style
- Rows with revenue > 1M: green background
\`\`\`

**Create chart visualization:**
\`\`\`
Create a sales trend query with line chart showing last 30 days for store A and B
\`\`\`

\`\`\`
Generate a mixed chart query showing monthly sales (bar) and target (line)
\`\`\`

\`\`\`
Create a bar chart comparing top 10 products by revenue
\`\`\`

### Common Mistakes to Avoid âš ï¸

**WRONG:**
\`\`\`sql
@row if æ›œæ—¥=åœŸ:background=#eeeeff
\`\`\`
- âŒ Has \`if\` keyword (not needed for @row)
- âŒ Uses \`=\` (single equals)
- âŒ Uses \`background\` instead of \`bg\`

**CORRECT:**
\`\`\`sql
@row æ›œæ—¥=="åœŸ":bg=#eeeeff
\`\`\`
- âœ… No \`if\` keyword
- âœ… Uses \`==\` (double equals)
- âœ… Uses \`bg\`
- âœ… String is quoted

### Documentation References

- Full guide: See project README.md
- Display options: See DISPLAY-OPTIONS-QUICK-GUIDE.md
- Row styling guide: See docs/ROW-STYLING-GUIDE.md
- PowerPoint copy: See docs/POWERPOINT-COPY-GUIDE.md
- Chart visualization: See docs/CHART-VISUALIZATION-GUIDE.md ğŸ†•
- Mixed chart examples: See docs/examples/mixed-chart-examples.sql ğŸ†•

---

## âš ï¸ FINAL REMINDER: Row Styling Syntax

\`\`\`sql
-- Column styling (uses 'if'):
@column å£²ä¸Š type=int if<0:color=red

-- Row styling (NO 'if', use '==', quote strings):
@row æ›œæ—¥=="åœŸ":bg=#eeeeff
@row å£²ä¸Š>1000000:bg=#ccffcc
\`\`\`

**Never mix these syntaxes!**

---
`;
    }

    /**
     * æ‹¡å¼µæ©Ÿèƒ½ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
     */
    private static getExtensionVersion(): string {
        try {
            const extension = vscode.extensions.getExtension('okuyamashin.querycanvas');
            return extension?.packageJSON.version || '0.1.2';
        } catch {
            return '0.1.2';
        }
    }
}

