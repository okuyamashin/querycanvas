# 条件付きスタイリング機能 実装記録

## 日時
2025年12月28日

## 実装内容

### 概要
SQLクエリ結果のテーブル表示において、**セルの値に応じて動的にスタイルを変更する機能**を実装しました。

### 主な機能

#### 1. データ型指定 (`type`)
カラムのデータ型を明示的に指定できるようになりました。

```sql
@column 金額 type=int
@column 割合 type=float
@column 価格 type=decimal
```

**サポートする型:**
- `int` : 整数
- `float` : 浮動小数点数
- `decimal` : 小数
- `text` : テキスト（将来の拡張用）

#### 2. 条件付きスタイル (`if演算子`)
セルの値に基づいて、条件的にスタイルを適用できるようになりました。

**構文:**
```
if<演算子><値>:<スタイル>=<値>,<スタイル>=<値>...
```

**サポートする演算子:**
- `<` : より小さい
- `>` : より大きい
- `<=` : 以下
- `>=` : 以上
- `==` : 等しい
- `!=` : 等しくない

**適用可能なスタイル:**
- `color=<色>` : 文字色
- `bg=<色>` または `backgroundColor=<色>` : 背景色
- `bold=true` : 太字
- `fontWeight=<値>` : フォントウェイト

### 実装例

#### 例1: マイナス値を赤字で表示
```sql
/**
 * @column 損益 type=int if<0:color=red
 */
SELECT 損益 FROM financial_data;
```

#### 例2: 閾値超過時に太字
```sql
/**
 * @column 売上 type=int if>1000:bold=true
 */
SELECT 売上 FROM sales_data;
```

#### 例3: 複数条件の適用
```sql
/**
 * @column 在庫 type=int if<=0:color=#999999 if>=10000:color=#ff0000,bold=true
 */
SELECT 在庫 FROM inventory;
```

#### 例4: 背景色の変更
```sql
/**
 * @column 達成率 type=float if<80:color=red,bg=#ffe6e6 if>=100:color=green,bold=true
 */
SELECT 達成率 FROM kpi_data;
```

### 技術的な実装詳細

#### 1. TypeScript型定義の追加 (`src/sqlCommentParser.ts`)

```typescript
export interface ConditionalStyleRule {
    operator: '<' | '>' | '<=' | '>=' | '==' | '!=';
    value: number;
    styles: {
        color?: string;
        backgroundColor?: string;
        bold?: boolean;
        fontWeight?: string;
    };
}

export interface ColumnDisplayOptions {
    // ... 既存のプロパティ ...
    type?: 'int' | 'float' | 'decimal' | 'text';
    conditionalStyles?: ConditionalStyleRule[];
}
```

#### 2. パーサーの拡張
`parseColumnDirective()` メソッドに以下の機能を追加:
- `type=<型>` の解析
- `if<演算子><値>:<スタイル>` の正規表現マッチング
- 複数のスタイルをカンマ区切りでパース
- 条件ルールの配列化

正規表現:
```typescript
/if([<>!=]+)(-?\d+(?:\.\d+)?):([^\s]+)/g
```

#### 3. Webviewでの条件評価関数 (`src/databaseClientPanel.ts`)

新しい関数 `generateConditionalStyle(value, options)` を追加:

1. セルの値を数値に変換
2. 各条件ルールを順番に評価
3. 条件が満たされた場合、指定されたスタイルを適用
4. 複数の条件が満たされる場合、後の条件が優先

```javascript
function generateConditionalStyle(value, options) {
    // 基本スタイル + 条件付きスタイルを評価
    // 演算子に応じて比較処理
    // 条件が満たされたらスタイルを適用
}
```

#### 4. レンダリングの変更
テーブルのセル生成部分を更新:

**変更前:**
```javascript
const style = opts ? generateColumnStyle(opts) : '';
```

**変更後:**
```javascript
const style = opts ? generateConditionalStyle(value, opts) : '';
```

### ファイル変更

#### 修正したファイル
1. **`src/sqlCommentParser.ts`**
   - `ConditionalStyleRule` インターフェースを追加
   - `ColumnDisplayOptions` に `type` と `conditionalStyles` を追加
   - `parseColumnDirective()` に条件付きスタイルのパース処理を追加
   - `generateConditionalStyle()` メソッドを追加

2. **`src/databaseClientPanel.ts`**
   - Webview内に `generateConditionalStyle()` 関数を追加
   - セルのスタイル適用処理を `generateConditionalStyle()` に変更

3. **`docs/specifications/display-options.md`**
   - 新機能のドキュメントを追加
   - 実用例を3つ追加（損益レポート、在庫アラート、KPI達成状況）
   - 更新履歴に記録

4. **`README.md`**
   - 機能リストに条件付きスタイリングを追加
   - 使用例を更新

5. **`.cursorrules`**
   - Cursor AIが新機能を理解できるように説明を追加
   - サンプルコードを追加

#### 新規作成したファイル
1. **`docs/examples/conditional-styling-examples.sql`**
   - 8つの実践的な使用例を含むサンプルSQL
   - 損益レポート、在庫アラート、KPI達成率、温度監視、株価変動、試験結果、経費精算、商品レビューなど

### 使用例一覧

作成したサンプルには以下の8つの実用例が含まれています:

1. **損益レポート** - マイナスを赤字、大きな利益を青字で表示
2. **在庫アラート** - 在庫切れを赤、少量を橙、十分を緑で表示
3. **KPI達成率** - 達成度に応じて色と背景を変更
4. **温度監視** - 高温を赤、適温を通常、低温を青で警告
5. **株価変動** - 前日比のプラスマイナスを色分け
6. **試験結果** - 不合格を赤、優秀を青で強調
7. **経費精算** - 高額申請を段階的に警告
8. **商品レビュー** - 評価スコアに応じて色分け

### テスト方法

1. QueryCanvasを起動
2. データベースに接続
3. `docs/examples/conditional-styling-examples.sql` のクエリを実行
4. 条件に応じたスタイリングが適用されることを確認

### ブランチ情報

- **ブランチ名:** `feature/conditional-column-styling`
- **コミットメッセージ:** "feat: add conditional column styling based on cell values"

### 次のステップ

この機能は以下のように拡張できます:

1. **文字列の条件付きスタイル**
   - `contains`, `startsWith`, `endsWith` などの文字列演算子
   - 正規表現によるパターンマッチング

2. **複雑な条件式**
   - AND/OR条件の組み合わせ
   - 範囲指定 (between)

3. **UIからの設定**
   - コード不要で条件を設定できるGUI

4. **プリセットの保存**
   - よく使う条件スタイルをテンプレート化

5. **エクスポート時の保持**
   - CSV/Excel出力時にスタイルを維持

## 技術的な学び

### 正規表現の工夫
条件付きスタイルのパースに使用した正規表現:
```javascript
/if([<>!=]+)(-?\d+(?:\.\d+)?):([^\s]+)/g
```

- `[<>!=]+` : 演算子（複数文字対応）
- `-?\d+(?:\.\d+)?` : 符号付き数値（小数対応）
- `([^\s]+)` : スタイル部分（スペース以外）

### 条件の優先順位
複数の条件が同時に満たされる場合、**後に定義された条件が優先**されます。

例:
```sql
if<100:color=red if<50:color=orange
```
値が30の場合、両方の条件が満たされますが、`color=orange` が適用されます。

### パフォーマンス考慮
- 条件評価は各セルで実行されるため、大量データでは負荷がかかる可能性
- 現在の実装では問題ないが、将来的にはキャッシングや最適化が必要かも

## まとめ

条件付きスタイリング機能により、QueryCanvasはデータの可視化がさらに強化されました。

**主な利点:**
- 📊 データの異常値を一目で把握
- 🎨 レポートの視認性向上
- ⚡ SQLコメントで簡単に設定
- 🤖 Cursor AIとの連携強化

この機能は、BI（ビジネスインテリジェンス）ツールや表計算ソフトの条件付き書式と同等の機能を、データベースクライアントで実現しています。

