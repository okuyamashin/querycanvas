# QueryCanvas 初期セットアップガイド

このドキュメントでは、QueryCanvas拡張機能の開発環境をセットアップし、初期設定を完了するまでの手順を説明します。

## 📋 前提条件

- Node.js と npm がインストールされていること
- VS Code または Cursor がインストールされていること
- VS Code API バージョン 1.85.0 以上

## 🚀 セットアップ手順

### Step 1: 開発環境の起動

#### 1.1 依存関係のインストール

```bash
npm install
```

#### 1.2 TypeScriptのコンパイル

```bash
npm run compile
```

または、ウォッチモードで自動コンパイル：

```bash
npm run watch
```

#### 1.3 デバッグ実行

1. VS Code/Cursorでこのプロジェクトを開く
2. **F5** キーを押す（または メニューから「実行」→「デバッグの開始」）
3. 新しいウィンドウ（Extension Development Host）が開きます

#### 1.4 Database Clientを開く

新しく開いたウィンドウで：

1. コマンドパレットを開く（`Cmd+Shift+P` / `Ctrl+Shift+P`）
2. 「**QueryCanvas: Open Database Client**」と入力して実行
3. Database Clientパネルが開きます

---

### Step 2: Cursor Rulesの設定

Cursor AIと連携するために、`.cursorrules`ファイルにQueryCanvasのルールを追加します。

#### 2.1 ボタンから設定（推奨）

1. Database Clientパネルを開く
2. 上部の「**📝 Cursor AI設定**」ボタンをクリック
3. `.cursorrules`ファイルにQueryCanvasのルールが自動的に追加されます

#### 2.2 コマンドパレットから設定

1. コマンドパレットを開く（`Cmd+Shift+P` / `Ctrl+Shift+P`）
2. 「**QueryCanvas: Setup Cursor AI Rules**」と入力して実行
3. `.cursorrules`ファイルにQueryCanvasのルールが自動的に追加されます

#### 2.3 確認

`.cursorrules`ファイルが作成または更新され、以下のようなセクションが追加されていることを確認してください：

```markdown
========================================
# QueryCanvas - Database Client Rules
# Auto-generated by QueryCanvas v0.3.0
========================================

## QueryCanvas Integration
...
```

**詳細:** [Cursor Rules セットアップ機能](./CURSOR-RULES-SETUP-FEATURE.md)

---

### Step 3: データベース接続の追加

#### 3.1 接続管理画面を開く

1. Database Clientパネルで「**⚙️ Manage Connections**」ボタンをクリック
2. 接続管理画面が開きます

#### 3.2 新しい接続を追加

1. 「**+ Add New Connection**」ボタンをクリック
2. 接続情報を入力：
   - **Name**: 接続名（例: "開発DB", "Production"）
   - **Type**: データベースタイプ（MySQL または PostgreSQL）
   - **Host**: データベースサーバーのホスト名またはIPアドレス
   - **Port**: ポート番号（MySQL: 3306, PostgreSQL: 5432）
   - **Database**: データベース名
   - **User**: ユーザー名
   - **Password**: パスワード（VS Code Secret Storageに安全に保存されます）
   - **SSL**: SSL接続が必要な場合は有効化
3. 「**Save**」ボタンをクリックして保存

#### 3.3 接続プロファイルの確認

接続一覧に追加した接続が表示されることを確認してください。

**注意:** パスワードはVS Code Secret Storageに暗号化されて保存されます。

---

### Step 4: データベースへの接続

#### 4.1 接続を選択

1. Database Clientパネルの上部にある接続ドロップダウンから、追加した接続を選択
2. 「**Connect**」ボタンをクリック

#### 4.2 接続状態の確認

接続が成功すると：
- 接続状態が「**●Connected**」と表示されます
- 接続エラーがある場合は、エラーメッセージが表示されます

**トラブルシューティング:**
- ホスト名、ポート番号、データベース名が正しいか確認
- ファイアウォール設定を確認
- SSL接続が必要な場合は、SSLオプションを有効化

---

### Step 5: テーブル定義の読み込み（スキーマ抽出）

データベースに接続したら、テーブル定義を抽出してMarkdownドキュメントとして保存します。

#### 5.1 スキーマ抽出の実行

1. Database Clientパネルで「**📋 Extract Schema**」ボタンをクリック
2. 抽出が完了するまで待機（テーブル数によって時間がかかります）
3. 成功メッセージが表示されます

#### 5.2 生成されたファイルの確認

スキーマドキュメントは以下の場所に保存されます：

```
querycanvas-schema/
└── tables/
    ├── users.md
    ├── orders.md
    └── ...
```

各テーブルのMarkdownファイルには以下が含まれます：
- テーブルの物理名と論理名（後から追加可能）
- カラム定義（名前、型、NULL許可、デフォルト値など）
- インデックス情報
- 外部キー情報
- 備考欄（Cursor AIと会話しながら追記可能）

#### 5.3 スキーマドキュメントの活用

生成されたMarkdownファイルを開いて、Cursor AIと会話しながら以下を追加できます：

- **論理名**: テーブルやカラムの意味を表す名前
- **説明**: テーブルやカラムの用途や意味
- **備考**: ビジネスルールや注意事項

**例:**
```
@Codebase querycanvas-schema/tables/users.md の users テーブルに論理名と説明を追加して
```

**詳細:** [スキーマドキュメント生成の仕様](./specifications/database-connection-layer.md)

---

## ✅ 初期設定完了チェックリスト

以下の項目がすべて完了していれば、初期設定は完了です：

- [ ] 開発環境が起動し、Database Clientパネルが開ける
- [ ] `.cursorrules`ファイルにQueryCanvasのルールが追加されている
- [ ] データベース接続プロファイルが追加されている
- [ ] データベースに接続できている（接続状態が「●Connected」）
- [ ] テーブル定義が抽出され、`querycanvas-schema/tables/`にMarkdownファイルが生成されている

---

## 🎯 次のステップ

初期設定が完了したら、以下の機能を試してみましょう：

### SQLクエリの実行

```sql
SELECT * FROM users LIMIT 10;
```

### 表示オプションの使用

```sql
/**
 * @column amount type=int align=right format=number comma=true if<0:color=red
 * @column created_at format=datetime pattern=yyyy/MM/dd_HH:mm
 */
SELECT amount, created_at FROM orders LIMIT 10;
```

### グラフ可視化

```sql
/**
 * @chart type=line x=日付 y=売上 title="売上推移"
 */
SELECT DATE_FORMAT(created_at, '%Y-%m-%d') AS 日付, SUM(amount) AS 売上
FROM orders
GROUP BY DATE_FORMAT(created_at, '%Y-%m-%d')
ORDER BY 日付;
```

### クエリ結果の保存

1. クエリを実行
2. 「**💾 Save Result**」ボタンをクリック
3. 名前とコメントを入力して保存

### Cursor AIとの連携

```
@Codebase .vscode/querycanvas-session.json のSQLを修正して、売上が1000以上の注文を取得するクエリに変更して
```

---

## 📚 関連ドキュメント

- [README.md](../README.md) - プロジェクトの概要と機能説明
- [Cursor Rules セットアップ機能](./CURSOR-RULES-SETUP-FEATURE.md) - Cursor AI統合の詳細
- [データベース接続層の仕様](./specifications/database-connection-layer.md) - 接続機能の技術仕様
- [TESTING.md](../TESTING.md) - テストとデバッグの手順

---

## 🐛 トラブルシューティング

### 接続エラーが発生する場合

1. 接続情報（ホスト、ポート、データベース名、ユーザー名、パスワード）を確認
2. データベースサーバーが起動しているか確認
3. ファイアウォール設定を確認
4. SSL接続が必要な場合は、SSLオプションを有効化

### スキーマ抽出が失敗する場合

1. データベースに接続できているか確認
2. データベースユーザーにテーブル情報を読み取る権限があるか確認
3. エラーメッセージを確認して、原因を特定

### Cursor Rulesが追加されない場合

1. ワークスペースのルートディレクトリに`.cursorrules`ファイルが作成されているか確認
2. ファイルの書き込み権限があるか確認
3. コマンドパレットから「QueryCanvas: Setup Cursor AI Rules」を実行してみる

---

**最終更新:** 2025-12-30

